<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Historial de m√°quina - Bob el Alquilador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script
      src="{{ url_for('static', filename='script/scripts.js') }}"
      defer
    ></script>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style/style.css') }}"
    />
    <link
      rel="icon"
      type="svg"
      href="{{ url_for('static', filename='image/Solo logo.svg') }}"
    />
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans">
    <header class="bg-bob-red text-white sticky top-0 z-50 shadow-md">
      <div
        class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center"
      >
        <a href="#" onclick="goHome()" title="Inicio">
          <img
            src="{{ url_for('static', filename='image/Completo.svg') }}"
            alt="Logo"
            class="h-12"
          />
        </a>
        <h1 class="text-xl font-bold">Historial de M√°quina</h1>
        <div></div>
      </div>
    </header>

    <main
      class="max-w-6xl mx-auto p-6 bg-white shadow-lg rounded-xl mt-8 mb-12"
    >
      <h2 class="text-2xl font-bold text-red-700 mb-6">Historial completo</h2>

      <div
        id="machineTitle"
        class="text-lg font-semibold mb-6 text-gray-700"
      ></div>

      <section class="mb-10">
        <h3 class="text-xl font-semibold text-bob-red mb-4">üü® Alquileres</h3>
        <div id="rentsList" class="space-y-4"></div>
      </section>

      <section class="mb-10">
        <h3 class="text-xl font-semibold text-bob-red mb-4">üü© Reservas</h3>
        <div id="reservationsList" class="space-y-4"></div>
      </section>

      <section>
        <h3 class="text-xl font-semibold text-bob-red mb-4">
          üõ†Ô∏è Mantenimientos
        </h3>
        <div id="maintenancesList" class="space-y-4"></div>
      </section>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const machineId = params.get("machine_id");

        if (!machineId) {
          alert("No se especific√≥ ninguna m√°quina.");
          return;
        }

        document.getElementById(
          "machineTitle"
        ).textContent = `Patente: ${machineId}`;

        try {
          // Obtener reservas
          const resReservations = await fetch(
            "/reservation/get_all_reservation",
            { method: "POST" }
          );
          const reservationsData = await resReservations.json();
          const reservas = (reservationsData || []).filter(
            (r) => r.machine_id === machineId
          );
          renderCards(reservas, "reservationsList", "type");

          // Obtener alquileres (usamos el mismo endpoint si llega a existir)
          const resRents = await fetch("/rent/get_all_by_machine", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ machine_id: machineId }),
          });
          const rentData = await resRents.json();
          const alquileres = rentData.rents || [];

          renderCards(alquileres, "rentsList", "type");

          // Obtener mantenimientos
          const resMaint = await fetch("/maintenance/get_all_maintenance");
          const maintData = await resMaint.json();
          const mantenimientos = maintData.maintenance.filter(
            (m) => m.machine_id === machineId
          );
          renderMaintenances(mantenimientos);
        } catch (e) {
          console.error("Error al cargar historial:", e);
        }
      });

      function renderCards(items, containerId, tipo) {
        const container = document.getElementById(containerId);
        if (!items.length) {
          container.innerHTML = `<p class="text-gray-500">No posee historial.</p>`;
          return;
        }

        for (const item of items) {
          const div = document.createElement("div");
          div.className = "border rounded p-4 bg-gray-50 shadow";

          div.innerHTML = `
          <p><strong>Inicio:</strong> ${item.start_day}</p>
          <p><strong>Fin:</strong> ${item.end_day}</p>
          <p><strong>Cliente:</strong> ${item.client_id}</p>
          <p><strong>Total:</strong> $${item.total_value}</p>
          ${
            item.shipment !== undefined
              ? `<p><strong>Env√≠o:</strong> ${item.shipment ? "S√≠" : "No"}</p>`
              : ""
          }
          ${
            item.extended
              ? `<p class="text-green-700 font-semibold">Alquiler extendido</p>`
              : ""
          }
        `;

          container.appendChild(div);
        }
      }

      function renderMaintenances(items) {
        const container = document.getElementById("maintenancesList");
        if (!items.length) {
          container.innerHTML = `<p class="text-gray-500">No posee historial.</p>`;
          return;
        }

        for (const item of items) {
          const div = document.createElement("div");
          div.className = "border rounded p-4 bg-gray-50 shadow";

          div.innerHTML = `
          <p><strong>Inicio:</strong> ${item.start_day}</p>
          <p><strong>Fin:</strong> ${item.end_day}</p>
          <p><strong>Empleado inicio:</strong> ${item.start_employee_id}</p>
          <p><strong>Empleado fin:</strong> ${item.end_employee_id}</p>
          <p><strong>Descripci√≥n:</strong> ${
            item.description || "Sin descripci√≥n"
          }</p>
        `;

          container.appendChild(div);
        }
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bob el Alquilador - Alquiler de Maquinarias de Construcci√≥n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="{{ url_for('static', filename='script/scripts.js') }}" defer></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style/style.css') }}">
  <link rel="icon" type="svg" href="{{ url_for('static', filename='image/Solo logo.svg') }}">
  <style>
    html {
      scroll-behavior: smooth;
    }
  </style>

  <!-- CALENDARIO -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script> <!-- Para espa√±ol -->

</head>

<body class="bg-gray-100 font-sans">

  <!-- Header -->
  <!-- Encabezado del usuario logueado -->
  <header class="bg-bob-red text-white sticky top-0 z-50 shadow-md">
    <div class="w-full max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">

      <!-- LOGO -->
      <div class="shrink-0">
        <a href="/panelEmpleado.html">
          <img src="{{ url_for('static', filename='image/Completo.svg') }}" alt="Bob el Alquilador" class="h-16">
        </a>
      </div>

      <!-- BARRA DE B√öSQUEDA -->
      <div class="flex-grow flex justify-center">
        <div class="relative w-full max-w-xl">
          <input type="text" id="searchInput" placeholder="Buscar maquinaria..."
            class="w-full py-2 px-4 pr-10 rounded-full text-gray-800 focus:outline-none shadow-md">
          <button onclick="buscarMaquinaria()"
            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-600">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>

      <!-- MI CUENTA (se completa autom√°ticamente si hay sesi√≥n) -->
      <div id="accountArea"></div>

      <!-- Dropdown -->
      <div id="userDropdown" class="hidden absolute right-0 mt-2 w-40 bg-white text-gray-700 rounded-lg shadow-lg z-50">
        <button onclick="window.location.href='/editar_perfil'"
          class="block w-full text-left px-4 py-2 hover:bg-gray-100">Editar perfil</button>
        <button onclick="window.location.href='/historial'"
          class="block w-full text-left px-4 py-2 hover:bg-gray-100">Ver historial</button>
        <button onclick="logout()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Cerrar sesi√≥n</button>
      </div>
    </div>
    <!-- Navigation debajo, 100% ancho -->
    <nav class="main-nav w-full">
      <ul class="flex flex-wrap justify-between text-white py- px-4 text-sm md:text-base">
        <li><a href="/main.html">Men√∫</a></li>
        <li><a href="machinery.html">Maquinarias</a></li> <!-- onclick="getMachine()" no funciona si no son botones -->
        <li class="relative" id="dropdown-categorias-container">
          <span id="dropdown-categorias-toggle" class="cursor-pointer text-white hover:underline inline-block">
            Categor√≠as <i class="fas fa-caret-down ml-1"></i>
          </span>

                <div id="dropdown-categorias-menu"
                    class="hidden absolute left-0 mt-2 bg-white rounded-md shadow-lg w-64 z-50"
                    style="color: #7f1d1d;">
                  <!-- Se rellena din√°micamente -->
                </div>
         <li><a href="/ask_question.html">Cont√°ctanos</a></li>
      </ul>
    </nav>

    <!-- Mobile Navigation Menu -->
    <div id="mobile-nav" class="hidden md:hidden mt-4 pb-2">
      <ul class="flex flex-col space-y-3">
        <li><a href="main.html" class="block py-1 hover:bg-bob-dark-red px-2 rounded">Men√∫</a></li>
        <li><a href="register_machinery.html" class="block py-1 hover:bg-bob-dark-red px-2 rounded">Dar de alta una
            maquinaria</a></li 
        <li><a href="/ask_question.html" >Cont√°ctanos</a></li>
      </ul>
    </div>
  </div>
  </header>

  <div class="max-w-xl mx-auto mt-12 bg-white rounded-xl shadow-lg p-8">
    
    <h1 class="text-3xl font-bold text-center text-bob-red mb-6">
      Alquiler Presencial
    </h1>

    <div id="mensaje" class="mt-4 text-center text-sm font-semibold"></div>

    <form id="form-alquiler" class="space-y-5">
      <div>
  <label class="block text-sm font-medium text-gray-700 mb-1">DNI del cliente</label>
  <input type="number" id="client_id" required
    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-bob-red" />
      <div class="mt-2 mb-4">
  <label class="inline-flex items-center">
    <input type="checkbox" id="toggleNuevoCliente" class="form-checkbox h-5 w-5 text-bob-red" />
    <span class="ml-2 text-sm text-gray-700">Registrar usuario</span>
  </label>
</div>

  </div>

<div id="campos-nuevo-cliente" class="space-y-3 hidden">
  <div><input id="name" type="text" placeholder="Nombre" class="w-full border rounded px-4 py-2" /></div>
  <div><input id="lastname" type="text" placeholder="Apellido" class="w-full border rounded px-4 py-2" /></div>
  <div><input id="email" type="email" placeholder="Email" class="w-full border rounded px-4 py-2" /></div>
  <div><input id="phone" type="tel" placeholder="Tel√©fono" class="w-full border rounded px-4 py-2" /></div>
  <div><input id="birthdate" type="date" placeholder="Fecha de nacimiento" class="w-full border rounded px-4 py-2" /></div>
</div>



      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ID de la m√°quina (patente)</label>
        <input type="text" id="machine_id" readonly
          class="w-full border border-gray-200 bg-gray-100 text-gray-700 rounded-lg px-4 py-2 cursor-not-allowed" />
      </div>


      <!-- Fechas -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de inicio</label>
        <input type="date" id="start_day" required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-bob-red"
          readonly />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de fin</label>
        <input type="date" id="end_day" required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-bob-red" />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ID del empleado</label>
        <input type="text" id="employee_id" required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-bob-red" />
      </div>

      <button type="submit"
        class="w-full bg-bob-red text-white font-semibold py-2 px-6 rounded-lg hover:bg-bob-dark-red transition">
        Confirmar alquiler
      </button>
    </form>

    
  </div>

  <script>

    function mostrarAviso(texto, color = "red") {
  const mensaje = document.getElementById("mensaje");
  mensaje.innerHTML = `
    <div class="bg-${color}-600 text-white px-4 py-3 rounded-md shadow-md flex items-center gap-2 mb-4">
      <i class="fas fa-exclamation-circle text-xl"></i>
      <span class="font-semibold">${texto}</span>
    </div>`;
}

function traducirErrorBackend(errorOriginal) {
  const mapaErrores = {
    "Ya existe un usuario con ese DNI": "Alquiler fallido por DNI ya existente.",
    "Usuario con ese email ya existe": "Alquiler fallido por correo ya existente.",
  };

  return mapaErrores[errorOriginal] || errorOriginal;
}


    const machineId = new URLSearchParams(window.location.search).get("machine_id");
    // 1. Obtener reservas y configurar calendario
    
    let reservas = [];
    
    Promise.all([
  // 1) RESERVAS
  fetch("/reservation/machine_reservations", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ machine_id: machineId })
  }).then(r => r.ok ? r.json() : Promise.reject("error reservas")),

  // 2) ALQUILERES
  fetch("/rent/get_all_by_machine", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ machine_id: machineId })
  }).then(r => r.ok ? r.json() : Promise.reject("error rents")),

  // 3) MANTENIMIENTO
  fetch(`/maintenance/get_active_maintenance/${machineId}`)
    .then(r => r.ok ? r.json() : Promise.resolve({ value: [] }))
])
.then(([resData, rentData, maintData]) => {
  //  Validaci√≥n por si el backend devuelve error en vez de value
  const reservasRent = Array.isArray(rentData.value) ? rentData.value : [];
  const reservasReserva = Array.isArray(resData.value) ? resData.value : [];

  const reservas = [...reservasReserva, ...reservasRent];


  const mantenimientoActivo = maintData.value.length > 0;
    // ‚îÄ‚îÄ‚îÄ NUEVO BLOQUE ‚îÄ‚îÄ‚îÄ
  const hoy = new Date();                       // 1) hoy en objeto Date
  const hoyISO = hoy.toISOString().split("T")[0];  // 2) hoy en formato YYYY-MM-DD

  // 3) ¬øLa m√°quina est√° ocupada hoy?
  const hoyOcupado = reservas.some(reserva => {
    const inicio = new Date(reserva.start_day);
    inicio.setDate(inicio.getDate() - 14);      // colch√≥n ‚àí14 d√≠as
    const fin = new Date(reserva.end_day);
    fin.setDate(fin.getDate() + 14);            // colch√≥n +14 d√≠as
    return hoy >= inicio && hoy <= fin;
  });
  // ‚îÄ‚îÄ FIN BLOQUE ‚îÄ‚îÄ

        if (hoyOcupado || mantenimientoActivo) {
  let texto = "";
  if (hoyOcupado) texto += "La m√°quina est√° reservada, alquilada o en mantenimiento hoy.";
  if (hoyOcupado && mantenimientoActivo) texto += "<br>";
  if (mantenimientoActivo) texto += "Adem√°s, tiene un mantenimiento activo.";
  mostrarAviso(texto, "yellow");

    setTimeout(() => {
    window.location.href = "/machinery.html";
  }, 2000); // 2 segundos

  
  const btnConfirmar = document.querySelector("#form-alquiler button[type='submit']");
btnConfirmar.disabled = true;
btnConfirmar.classList.add("opacity-50", "cursor-not-allowed");
  document.getElementById("start_day").value = "";
  document.getElementById("start_day").disabled = true;
  document.getElementById("end_day").disabled = true;
  return;
}



        // Setear la fecha de hoy como inicio
        document.getElementById("start_day").value = hoyISO;
        document.getElementById("start_day").readOnly = true;

        // Setear m√≠nimo para end_day (hoy + 7)
        const fechaMinFin = new Date(hoy);
        fechaMinFin.setDate(hoy.getDate() + 7);
        const finISO = fechaMinFin.toISOString().split('T')[0];
        document.getElementById("end_day").min = finISO;

        inicializarCalendarioFin(fechaMinFin);
})
.catch(error => {
  mostrarAviso("Error al cargar disponibilidad de la m√°quina.", "red");
  console.error(error);
});

    // Inicializar Flatpickr solo en end_day
    function inicializarCalendarioFin(minFechaFin) {
      const diasBloqueados = reservas.map(reserva => {
        const fechaInicio = new Date(reserva.start_day);
        fechaInicio.setDate(fechaInicio.getDate() - 14);
        const fechaFin = new Date(reserva.end_day);
        fechaFin.setDate(fechaFin.getDate() + 14);
        return {
          from: fechaInicio.toISOString().split('T')[0],
          to: fechaFin.toISOString().split('T')[0]
        };
      });

      flatpickr("#end_day", {
        locale: { firstDayOfWeek: 1 },
        minDate: minFechaFin.toISOString().split('T')[0],
        disable: diasBloqueados,
      });
    }



    document.addEventListener("DOMContentLoaded", () => {

      const params = new URLSearchParams(window.location.search);
      const machineId = params.get("machine_id");
      // Setear el campo del ID de la m√°quina
      const machineInput = document.getElementById("machine_id");
      machineInput.value = machineId;

      const toggleNuevoCliente = document.getElementById("toggleNuevoCliente");
const camposNuevoCliente = document.getElementById("campos-nuevo-cliente");

toggleNuevoCliente.addEventListener("change", () => {
  if (toggleNuevoCliente.checked) {
    camposNuevoCliente.classList.remove("hidden");
  } else {
    camposNuevoCliente.classList.add("hidden");
  }
});



      // Cargar categor√≠as si aplica
      if (typeof cargarCategoriasInicio === "function") {
        cargarCategoriasInicio();
      }

      fetch("/session/employee")
        .then(res => res.json())
        .then(data => {
          console.log("üëâ Empleado desde sesi√≥n:", data); // üëà
          if (data.employee_id) {
            const empInput = document.getElementById("employee_id");
            empInput.value = data.employee_id;
            empInput.readOnly = true;
            empInput.classList.add("bg-gray-100", "cursor-not-allowed");
          }
        })
        .catch(err => {
          console.warn("No se pudo obtener el n√∫mero de empleado:", err);
        });


      const form = document.getElementById("form-alquiler");
      const mensaje = document.getElementById("mensaje");
      const startInput = document.getElementById("start_day");
      //startInput.readOnly = true;
      startInput.classList.add("bg-gray-100", "cursor-not-allowed");
      const endInput = document.getElementById("end_day");

      form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const dni = document.getElementById("client_id").value;
  const name = document.getElementById("name")?.value;
  const lastname = document.getElementById("lastname")?.value;
  const email = document.getElementById("email")?.value;
  const phone = document.getElementById("phone")?.value;
  const birthdate = document.getElementById("birthdate")?.value;
  const isNuevo = document.getElementById("toggleNuevoCliente").checked;

  // Si se quiere registrar un nuevo cliente, validar y registrar primero
  if (isNuevo) {
    if (!name || !lastname || !email || !phone || !birthdate) {
      mostrarError("Por favor complet√° todos los campos del nuevo cliente.");
      return;
    }

    const crearCliente = await fetch("/signin_manual", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        dni,
        name,
        lastname,
        email,
        phone,
        birthdate,
        password: "cliente123",
      }),
    });

    if (!crearCliente.ok) {
  let textoError = "Error al crear el cliente.";
  try {
    const resultado = await crearCliente.json();
    textoError = traducirErrorBackend(resultado.error || textoError);
  } catch {
    // Por si no es JSON v√°lido
  }
  mostrarError(textoError);
  return;
}

  }

  // Ahora s√≠: enviar el alquiler
  const alquiler = {
    start_day: document.getElementById("start_day").value,
    end_day: document.getElementById("end_day").value,
    client_id: dni,
    machine_id: machineId,
    employee_id: document.getElementById("employee_id").value,
  };

  const response = await fetch("/rent/rent_machine", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(alquiler),
  });

  if (response.ok) {
  mensaje.innerHTML = `
    <div class="bg-green-600 text-white px-4 py-3 rounded-md shadow-md flex items-center gap-2 mt-4">
      <i class="fas fa-check-circle text-xl"></i>
      <span class="font-semibold">Alquiler registrado correctamente.</span>
    </div>
  `;
  setTimeout(() => {
    window.location.href = "/machinery.html";  
  }, 2000);

    form.reset();
    document.getElementById("end_day").disabled = true;
    document.getElementById("campos-nuevo-cliente").classList.add("hidden");
  } else {
    const result = await response.json();
    const errorMsg = result.error === "Usuario no registrado"
      ? "Alquiler fallido por usuario no registrado"
      : result.error || "Error desconocido en el alquiler.";

    mostrarError(errorMsg);
  }
});

    });

  function verificarCliente() {
  const dni = document.getElementById("client_id").value;
  if (!dni) {
    mostrarError("Ingres√° un DNI primero.");
    return;
  }

  fetch("/users/check_client", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ dni })
  })
    .then(res => {
      if (res.ok) {
        mensaje.innerHTML = `
        <div class="bg-green-600 text-white px-4 py-2 rounded shadow mt-2">El cliente ya est√° registrado </div>`;
        document.getElementById("campos-nuevo-cliente").classList.add("hidden");
      } else if (res.status === 404) {
        mensaje.innerHTML = `
        <div class="bg-yellow-500 text-white px-4 py-2 rounded shadow mt-2">El cliente no est√° registrado. Ingres√° sus datos.</div>`;
            document.getElementById("campos-nuevo-cliente").classList.remove("hidden");
          } else {
            throw new Error("Error verificando cliente");
          }
        })
        .catch(err => {
          mensaje.innerHTML = `
      <div class="bg-red-600 text-white px-4 py-2 rounded shadow mt-2">Error al verificar el cliente.</div>`;
    });
}



    function crearNuevoCliente() {
      const dni = document.getElementById("client_id").value;
      const name = document.getElementById("name").value;
      const lastname = document.getElementById("lastname").value;
      const email = document.getElementById("email").value;
      const phone = document.getElementById("phone").value;
      const birthdate = document.getElementById("birthdate").value;
      const password = "cliente123"; // contrase√±a por defecto

  if (!dni || !name || !lastname || !email || !phone || !birthdate) {
    mostrarError("Por favor complet√° todos los campos.");
    return;
  }

  fetch("/signin_manual", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ dni, name, lastname, email, phone, birthdate, password })
  })
    .then(async res => {
      const data = await res.json();

      if (!res.ok) {
        const mensajeTraducido = traducirErrorBackend(data.error || "Error creando el cliente");
        mostrarError(mensajeTraducido);
        return;
      }

      mensaje.innerHTML = `
        <div class="bg-green-600 text-white px-4 py-2 rounded shadow mt-2">Cliente creado correctamente üéâ</div>`;
      document.getElementById("campos-nuevo-cliente").classList.add("hidden");
    })
    .catch(err => {
      mostrarError("Error de conexi√≥n con el servidor.");
      console.error(err);
    });
}

    function mostrarError(texto) {
      const mensaje = document.getElementById("mensaje");
      mensaje.innerHTML = `
    <div class="bg-red-600 text-white px-4 py-2 rounded shadow mt-2">
      ${texto}
    </div>
  `;
    }

    // Funci√≥n que elimina los n√∫meros si se intentan ingresar
    function bloquearNumeros(inputId) {
      const input = document.getElementById(inputId);
      input.addEventListener("input", () => {
        input.value = input.value.replace(/[0-9]/g, '');
      });
    }


  </script>


</body>

<!-- FOOTER -->

<footer id="contacto" class="bg-bob-dark-red text-white py-10">
  <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8">

    <!-- Columna 1: Redes + legales -->
    <div>
      <h3 class="text-lg font-bold mb-2">Conect√° con nosotros</h3>
      <div class="flex space-x-4 mb-4">
        <a href="https://instagram.com/bobelalquilador" target="_blank" class="hover:text-gray-300 transition">
          <i class="fab fa-instagram text-2xl"></i>
        </a>
        <a href="https://wa.me/5492245400777" target="_blank" class="hover:text-gray-300 transition">
          <i class="fab fa-whatsapp text-2xl"></i>
        </a>
      </div>
      <ul class="space-y-1">
        <li>
          <a href="terminos.html" class="hover:underline">T√©rminos y Condiciones</a>
        </li>
      </ul>
    </div>

    <!-- Columna 2: Contacto -->
    <div>
      <h3 class="text-lg font-bold mb-2">Contacto</h3>
      <ul class="space-y-2">
        <li><i class="fas fa-phone mr-2"></i> +54 11 5555-5555</li>
        <li><i class="fas fa-envelope mr-2"></i> info@bobelaquilador.com</li>
        <li><i class="fas fa-clock mr-2"></i> Lun-Vie: 9:00 - 17:00</li>
      </ul>
    </div>

    <!-- Columna 3: Mapa -->
    <div>
      <h3 class="text-lg font-bold mb-2">Ubicaci√≥n</h3>
      <div class="rounded-lg overflow-hidden shadow-lg">
        <iframe
          src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3272.118324865909!2d-57.937655799999995!3d-34.90348000000001!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x95a2e66a8fcdf951%3A0x9191a5ff1fbbe5d5!2sFacultad%20de%20Inform%C3%A1tica%20-%20UNLP!5e0!3m2!1ses!2sar!4v1747357664109!5m2!1ses!2sar"
          width="100%" height="200" style="border:0;" allowfullscreen="" loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>

  </div>

  <!-- L√≠nea inferior -->
  <div class="mt-6 border-t border-white/20 pt-4 text-center text-sm">
    ¬© 2025 Bob El Alquilador. Todos los derechos reservados.
  </div>
</footer>

</html>